<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Asset List | My Astra Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    .status-active {
      background-color: #2ecc71;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
    }

    .status-inactive {
      background-color: #e74c3c;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
    }

    .status-maintenance {
      background-color: #f1c40f;
      color: #1e1e2f;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      display: inline-block;
    }

    .edit-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .edit-btn:hover {
      background: #2980b9;
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 4px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.75rem;
      margin-left: 6px;
    }

    .delete-btn:hover {
      background: #c0392b;
    }

    .content {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1100px;
    }

    th, td {
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
    }
  </style>
</head>
<body>
<div class="sidebar">
  <div class="sidebar-logo">
    <img src="../images/Astra-logo.png" alt="Bro Logo" />
  </div>
  <a href="homepage.html"><i class="fas fa-house"></i> Home</a>
  <a href="asset-list.html"><i class="fas fa-list"></i> Asset List</a>
  <a href="calendar.html"><i class="fas fa-calendar-alt"></i> Calendar</a>
  <a href="detail.html"><i class="fas fa-file-alt"></i> View Details</a>
  <a href="contact.html"><i class="fas fa-envelope"></i> Contact</a>
  <a href="database.html"><i class="fas fa-database"></i> Database</a>
  <a href="faq.html"><i class="fas fa-question-circle"></i> FAQ</a>
  <a href="users-database.html"><i class="fas fa-user-cog"></i> Manage Users</a>
</div>

<div class="main-content fade-in">
  <header><span class="brand-name">Asset List</span></header>
  <div class="breadcrumb">Home &gt; Asset List</div>
  <div class="content">
    <button id="addAssetBtn" class="add-button" onclick="openModal()">Add new item</button>
    <table>
      <thead>
        <tr>
          <th>Asset ID</th>
          <th>Asset Name</th>
          <th>Purchase Date</th>
          <th>Lifespan Years</th>
          <th>Maintenance Interval (Days)</th>
          <th>Last Maintenance Date</th>
          <th>Next Maintenance Date</th>
          <th>Status</th>
          <th>Location</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="asset-table-body"></tbody>
    </table>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal fade-in" id="modalBox">
    <span class="close-btn" onclick="closeModal()">×</span>
    <h2 id="modalTitle">Add New Asset</h2>
    <form id="assetForm">
      <input type="hidden" name="id" id="assetId" />
    
      <label>Asset Name: <input type="text" name="name" required /></label><br><br>
      <label>Type:
        <select name="type" required>
          <option value="">Select type</option>
          <option value="Laptop">Laptop</option>
          <option value="Monitor">Monitor</option>
          <option value="Peripheral">Peripheral</option>
          <option value="Projector">Projector</option>
          <option value="Printer">Printer</option>
          <option value="Scanner">Scanner</option>
          <option value="Networking">Networking</option>
          <option value="Storage">Storage</option>
          <option value="Tablet">Tablet</option>
          <option value="Microcomputer">Microcomputer</option>
        </select>
      </label><br><br>      
      <label>Cost (€): <input type="number" name="cost" step="0.01" min="0" required /></label><br><br>
      <label>Vendor:
        <select name="vendor" required>
          <option value="">Select vendor</option>
          <option value="Dell">Dell</option>
          <option value="HP">HP</option>
          <option value="Lenovo">Lenovo</option>
          <option value="Logitech">Logitech</option>
          <option value="Apple">Apple</option>
          <option value="Acer">Acer</option>
          <option value="Canon">Canon</option>
          <option value="Samsung">Samsung</option>
          <option value="Cisco">Cisco</option>
          <option value="Epson">Epson</option>
          <option value="Asus">Asus</option>
          <option value="Microsoft">Microsoft</option>
          <option value="Raspberry">Raspberry</option>
          <option value="Other">Other</option>
        </select>
      </label><br><br>      
      <label>Purchase Date: <input type="date" name="purchaseDate" required /></label><br><br>
      <label>Lifespan (Years): <input type="number" name="lifespanYears" min="1" required /></label><br><br>
      <label>Maintenance Interval (Days): <input type="number" name="maintenance_interval" min="1" required /></label><br><br>
      <label>Last Maintenance Date: <input type="date" name="lastMaintenance" required /></label><br><br>
      <label>Status:
        <select name="status" required>
          <option value="">Select status</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Due">Due</option>
          <option value="Completed">Completed</option>
          <option value="Retired">Retired</option>
        </select>
      </label><br><br>
      <label>Location:
        <select name="location" required>
          <option value="">Select location</option>
          <option value="Tallinn - Front Desk">Tallinn - Front Desk</option>
          <option value="Tallinn - Office 1">Tallinn - Office 1</option>
          <option value="Tallinn - Office 2">Tallinn - Office 2</option>
          <option value="Tallinn - IT Room">Tallinn - IT Room</option>
          <option value="Tallinn - Server Room">Tallinn - Server Room</option>
          <option value="Tallinn - Meeting Room">Tallinn - Meeting Room</option>
          <option value="Tallinn - Archive Room">Tallinn - Archive Room</option>
          <option value="Tallinn - Break Room">Tallinn - Break Room</option>
          <option value="Tallinn - HR Office">Tallinn - HR Office</option>
          <option value="Tallinn - Support Desk">Tallinn - Support Desk</option>
          <option value="Tallinn - Developer Hub">Tallinn - Developer Hub</option>
          <option value="Tallinn - Lab">Tallinn - Lab</option>
          <option value="Tallinn - Marketing Room">Tallinn - Marketing Room</option>
          <option value="Other">Other</option>
        </select>
      </label><br><br>      
      <label>Owner:
        <select name="owner" required>
          <option value="">Select owner</option>
          <option value="Alice">Alice</option>
          <option value="Bob">Bob</option>
          <option value="Eve">Eve</option>
          <option value="Carol">Carol</option>
          <option value="Dan">Dan</option>
          <option value="Frank">Frank</option>
          <option value="Grace">Grace</option>
          <option value="Heidi">Heidi</option>
          <option value="Ivan">Ivan</option>
          <option value="Judy">Judy</option>
          <option value="Zoe">Zoe</option>
          <option value="Other">Other</option>
        </select>
      </label><br><br>      
    
      <button type="submit" class="add-button">Save Asset</button>
    </form>    
  </div>
</div>

<script>
  let editMode = false;
  let editingId = null;

  async function loadAssets() {
    const res = await fetch("http://localhost:3000/assets");
    const assets = await res.json();
    const tbody = document.getElementById("asset-table-body");
    tbody.innerHTML = "";

    assets.forEach(asset => {
  const tr = document.createElement("tr");

  // Determine status class
  let statusClass = "";
  if (asset.status?.toLowerCase() === "active") statusClass = "status-active";
  else if (asset.status?.toLowerCase() === "inactive") statusClass = "status-inactive";
  else if (asset.status?.toLowerCase().includes("maintenance")) statusClass = "status-maintenance";

  let nextMaintenance = "—";
  if (asset.maintenance_date && asset.maintenance_interval) {
    const lastDate = new Date(asset.maintenance_date);
    lastDate.setDate(lastDate.getDate() + parseInt(asset.maintenance_interval));
    nextMaintenance = lastDate.toISOString().split("T")[0];
  }

  // Set HTML
  tr.innerHTML = `
    <td>${asset.id}</td>
    <td><a href="detail.html?sn=${asset.id}" style="color: #00f2fe; text-decoration: underline;">${asset.name}</a></td>
    <td>${asset.purchase_date ? asset.purchase_date.split("T")[0] : "—"}</td>
    <td>${asset.lifespan || "—"}</td>
    <td>${asset.maintenance_interval || "—"}</td>
    <td>${asset.maintenance_date ? asset.maintenance_date.split("T")[0] : "—"}</td>
    <td>${nextMaintenance}</td>
    <td><span class="${statusClass}">${asset.status || "Unknown"}</span></td>
    <td>${asset.location || "—"}</td>
    <td>
      <button class="edit-btn" onclick='editAsset(${JSON.stringify(asset)})'>Edit</button>
      <button class="delete-btn" onclick='deleteAsset(${asset.id})'>Delete</button>
    </td>
  `;

  // ✅ Debug log
  console.log("Generated row for:", asset.name, tr);

  tbody.appendChild(tr);
});
  }

  function openModal() {
    document.getElementById("modalOverlay").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modalOverlay").style.display = "none";
    document.getElementById("assetForm").reset();
    editingId = null;
    editMode = false;
    document.getElementById("modalTitle").innerText = "Add New Asset";
  }

  function editAsset(asset) {
  openModal();
  editMode = true;
  editingId = asset.id;
  document.getElementById("modalTitle").innerText = "Edit Asset";

  document.getElementById("assetId").value = asset.id;
  document.querySelector("[name='name']").value = asset.name || "";
  document.querySelector("[name='type']").value = asset.type || "";
  document.querySelector("[name='cost']").value = asset.cost || "";
  document.querySelector("[name='vendor']").value = asset.vendor || "";
  document.querySelector("[name='purchaseDate']").value = asset.purchase_date ? asset.purchase_date.split("T")[0] : "";
  document.querySelector("[name='lifespanYears']").value = asset.lifespan || "";
  document.querySelector("[name='maintenance_interval']").value = asset.maintenance_interval || "";
  document.querySelector("[name='lastMaintenance']").value = asset.maintenance_date ? asset.maintenance_date.split("T")[0] : "";
  document.querySelector("[name='status']").value = asset.status || "";
  document.querySelector("[name='location']").value = asset.location || "";
  document.querySelector("[name='owner']").value = asset.owner || "";
}

  document.getElementById("assetForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const assetData = Object.fromEntries(formData.entries());

  const payload = {
  name: assetData.name,
  type: assetData.type,
  cost: parseFloat(assetData.cost),
  vendor: assetData.vendor,
  purchase_date: assetData.purchaseDate,
  lifespan: parseInt(assetData.lifespanYears),
  maintenance_interval: parseInt(assetData.maintenance_interval),
  maintenance_date: assetData.lastMaintenance,
  status: assetData.status,
  location: assetData.location,
  owner: assetData.owner
};

    if (editMode && editingId) {
      await fetch(`http://localhost:3000/assets/${editingId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    } else {
      await fetch("http://localhost:3000/assets", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    }

    closeModal();
    loadAssets();
  });

  document.addEventListener("DOMContentLoaded", loadAssets);

  async function deleteAsset(id) {
    if (confirm("Olete kindlad et soovite kustutada selle vara?")) {
      await fetch(`http://localhost:3000/assets/${id}`, {
        method: "DELETE"
      });
      loadAssets();
    }
  }
</script>
</body>
</html>